# 🔄 Визуальная схема процесса регистрации

## 📋 Полный цикл регистрации и активации

```
👤 ПОЛЬЗОВАТЕЛЬ                 🖥️  DJANGO СЕРВЕР                   🗄️  БАЗА ДАННЫХ
     │                              │                                │
     │ 1. Заполняет форму           │                                │
     │    регистрации               │                                │
     ├──────────────────────────────▶│                                │
     │                              │ 2. Валидация данных           │
     │                              │    - Email уникален?           │
     │                              │    - Пароль сложный?           │
     │                              │    - Телефон в формате?        │
     │                              ├────────────────────────────────▶│
     │                              │                                │ 3. Создание пользователя
     │                              │                                │    is_active = False
     │                              │                                │    email_confirmed = False
     │                              │◀────────────────────────────────┤
     │                              │                                │
     │                              │ 4. Генерация токена            │
     │                              │    token = "css10e-abc123..."  │
     │                              │    uid = "OA" (user.id=8)      │
     │                              │                                │
     │                              │ 5. Создание ссылки активации   │
     │                              │    /activate/OA/css10e-abc.../ │
     │                              │                                │
     │                              │ 6. Отправка email (в консоль)  │
     │                              │    📧 Subject: Подтверждение   │
     │                              │    📝 Message: Добро пожаловать│
     │                              │    🔗 Link: activation_link    │
     │                              │                                │
     │ 7. Видит письмо в консоли    │                                │
     │    Django сервера            │                                │
     │◀──────────────────────────────┤                                │
     │                              │                                │
     │ 8. Копирует ссылку из        │                                │
     │    консоли и открывает       │                                │
     │    в браузере                │                                │
     ├──────────────────────────────▶│                                │
     │                              │ 9. Обработка активации        │
     │                              │    - Расшифровка UID → user.id │
     │                              │    - Поиск пользователя        │
     │                              │    - Проверка токена           │
     │                              │    - Проверка срока действия   │
     │                              ├────────────────────────────────▶│
     │                              │                                │ 10. Активация пользователя
     │                              │                                │     is_active = True
     │                              │                                │     email_confirmed = True
     │                              │◀────────────────────────────────┤
     │                              │                                │
     │ 11. Видит страницу           │ 12. Рендер страницы            │
     │     "Аккаунт активирован!"   │     activation_success.html    │
     │◀──────────────────────────────┤                                │
     │                              │                                │
     │ 13. Может войти в систему    │                                │
     │     через /login/            │                                │
     │                              │                                │
```

## 🔐 Схема проверки токена

```
ЗАПРОС НА АКТИВАЦИЮ: /activate/OA/css10e-abc123.../

┌─────────────────────┐
│ 1. Получение URL    │
│    uidb64 = "OA"    │
│    token = "css..." │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ 2. Расшифровка UID  │
│    "OA" → 8         │
│    (base64 decode)  │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ 3. Поиск user.id=8  │
│    в базе данных    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐       ❌ НЕТ
│ 4. Пользователь     ├──────────────┐
│    найден?          │              │
└─────────┬───────────┘              │
          │ ✅ ДА                    │
          ▼                          │
┌─────────────────────┐              │
│ 5. Проверка токена  │              │
│    token_generator. │              │
│    check_token()    │              │
└─────────┬───────────┘              │
          │                          │
          ▼                          │
┌─────────────────────┐       ❌ НЕТ │
│ 6. Токен            ├──────────────┤
│    действителен?    │              │
└─────────┬───────────┘              │
          │ ✅ ДА                    │
          ▼                          │
┌─────────────────────┐              │
│ 7. АКТИВАЦИЯ        │              │
│    is_active = True │              │
│    email_confirmed  │              │
│    = True           │              │
└─────────┬───────────┘              │
          │                          │
          ▼                          │
┌─────────────────────┐              │
│ 8. Успешная         │              │
│    страница         │              │
└─────────────────────┘              │
                                     │
                                     ▼
                           ┌─────────────────────┐
                           │ ОШИБКА АКТИВАЦИИ    │
                           │ - Пользователь не   │
                           │   найден            │
                           │ - Токен недействи-  │
                           │   телен/истек       │
                           │ - Уже активирован   │
                           └─────────────────────┘
```

## 📧 Структура письма активации

```
📧 EMAIL CONTENT (в консоли Django сервера)

┌─────────────────────────────────────────────────────────────┐
│ Content-Type: multipart/alternative                        │
│ Subject: =?utf-8?b?...Подтверждение регистрации...         │
│ From: noreply@shop.local                                   │
│ To: user@example.com                                       │
│ Date: Fri, 11 Jul 2025 09:50:52 -0000                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📝 ТЕКСТОВАЯ ВЕРСИЯ:                                       │
│                                                             │
│ Добро пожаловать в Интернет-магазин!                      │
│                                                             │
│ Здравствуйте, Иван!                                       │
│                                                             │
│ Спасибо за регистрацию в нашем интернет-магазине.         │
│ Для завершения регистрации и активации вашего аккаунта,   │
│ пожалуйста, перейдите по ссылке ниже:                     │
│                                                             │
│ 🔗 http://localhost:8000/activate/OA/css10e-abc123.../     │
│                                                             │
│ Если вы не регистрировались на нашем сайте, просто        │
│ проигнорируйте это письмо.                                │
│                                                             │
│ Ссылка действительна в течение 24 часов с момента         │
│ регистрации.                                               │
│                                                             │
│ С уважением,                                               │
│ Команда Интернет-магазин                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🎨 HTML ВЕРСИЯ:                                            │
│                                                             │
│ <!DOCTYPE html>                                            │
│ <html>                                                     │
│ <head>                                                     │
│   <style>                                                  │
│     .header { background: #007bff; color: white; }        │
│     .button { background: #28a745; color: white; }        │
│   </style>                                                 │
│ </head>                                                    │
│ <body>                                                     │
│   <div class="header">                                     │
│     <h1>🛒 Интернет-магазин</h1>                          │
│     <h2>Подтверждение регистрации</h2>                    │
│   </div>                                                   │
│   <div class="content">                                    │
│     <h3>Добро пожаловать, Иван!</h3>                      │
│     <p>Спасибо за регистрацию...</p>                      │
│     <a href="http://localhost:8000/activate/..."          │
│        class="button">✅ Активировать аккаунт</a>         │
│   </div>                                                   │
│ </body>                                                    │
│ </html>                                                    │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Альтернативные сценарии

### ✅ УСПЕШНАЯ АКТИВАЦИЯ
```
URL: /activate/OA/valid-token/
  ↓
✅ Пользователь найден
✅ Токен действителен  
✅ Аккаунт активирован
  ↓
🎉 activation_success.html
   "Ваш аккаунт успешно активирован!"
```

### ❌ НЕУДАЧНАЯ АКТИВАЦИЯ
```
URL: /activate/XX/invalid-token/
  ↓
❌ Пользователь не найден
ИЛИ
❌ Токен недействителен/истек
ИЛИ  
❌ Уже активирован ранее
  ↓
🚫 activation_invalid.html
   "Ссылка активации недействительна"
```

### ⏰ ИСТЕКШИЙ ТОКЕН
```
Регистрация: 11.07.2025 10:00
Переход по ссылке: 12.07.2025 11:00 (25 часов спустя)
  ↓
❌ Токен истек (лимит 24 часа)
  ↓
🚫 "Срок действия ссылки истёк"
   "Попробуйте зарегистрироваться заново"
```
